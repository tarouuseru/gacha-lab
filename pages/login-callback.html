<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Logging in...</title>
  </head>
  <body>
    <p>Logging in...</p>

    <script src="./config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
      const STATE_KEY = "gacha_state_v1";
      const config = window.APP_CONFIG || {};
      const { SUPABASE_URL, SUPABASE_ANON_KEY } = config;

      if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
        location.replace(`${location.origin}/?restore=1`);
      }

      const supabaseClient =
        SUPABASE_URL && SUPABASE_ANON_KEY
          ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
          : null;

      function loadState() {
        try {
          const raw = localStorage.getItem(STATE_KEY);
          if (raw) return JSON.parse(raw);
        } catch {
          // ignore parse errors
        }
        return {
          v: 1,
          guest_token: localStorage.getItem("guest_token") || null,
          firstSpin: { done: false, status: null, result: null, at: null },
          auth: { loggedIn: false, userId: null },
          ui: { step: "INIT", lastError: null },
        };
      }

      function saveState(state) {
        localStorage.setItem(STATE_KEY, JSON.stringify(state));
      }

      async function finalizeLogin() {
        if (!supabaseClient) {
          location.replace("/?restore=1");
          return;
        }

        const { data } = await supabaseClient.auth.getSession();
        if (!data?.session) {
          location.replace("/?restore=1");
          return;
        }

        localStorage.setItem("is_logged_in", "1");
        const state = loadState();
        state.auth = { ...state.auth, loggedIn: true };
        state.ui = { ...state.ui, step: "SECOND_READY" };
        if (state.firstSpin?.done || localStorage.getItem("did_first_spin") === "1") {
          localStorage.setItem("can_second_spin", "1");
        }
        saveState(state);
        location.replace("/?restore=1");
      }

      finalizeLogin();
    </script>
  </body>
</html>
