<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../styles.css" />
    <style>
      .admin-grid {
        display: grid;
        gap: 16px;
      }
      .admin-row {
        display: grid;
        gap: 8px;
      }
      .admin-row label {
        font-size: 12px;
        color: var(--muted);
      }
      .admin-row input,
      .admin-row select {
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        background: #0d1218;
        color: var(--text);
      }
      .admin-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      .admin-table {
        display: grid;
        gap: 12px;
      }
      .admin-card {
        background: rgba(255, 255, 255, 0.08);
        padding: 12px;
        border-radius: 12px;
        display: grid;
        gap: 8px;
      }
      .admin-inline {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 8px;
      }
      .admin-status {
        font-size: 12px;
        color: var(--muted);
      }
    </style>
  </head>
  <body>
    <header>
      <div class="brand">GACHA LAB ADMIN</div>
    </header>
    <main>
      <section class="card hero admin-grid">
        <div class="admin-row">
          <label for="apiBase">API Base</label>
          <input id="apiBase" type="text" />
        </div>
        <div class="admin-row">
          <label for="adminToken">ADMIN_TOKEN</label>
          <input id="adminToken" type="password" />
        </div>
        <div class="admin-row">
          <label for="gachaId">GACHA_ID</label>
          <input id="gachaId" type="text" />
        </div>
        <div class="admin-actions">
          <button class="btn" id="loadGacha">gacha load</button>
          <button class="btn secondary" id="saveGacha">gacha update</button>
        </div>
        <div id="gachaStatus" class="admin-status"></div>
        <div class="admin-inline">
          <div class="admin-row">
            <label for="winRate">win_rate</label>
            <input id="winRate" type="number" step="0.01" min="0" max="1" />
          </div>
          <div class="admin-row">
            <label for="isActive">is_active</label>
            <select id="isActive">
              <option value="true">true</option>
              <option value="false">false</option>
            </select>
          </div>
        </div>
      </section>
      <section class="card admin-grid">
        <div class="admin-actions">
          <button class="btn" id="saveGachaId">gacha_id save</button>
          <button class="btn secondary" id="testSpin">spin test</button>
        </div>
        <div id="spinStatus" class="admin-status"></div>
        <pre id="spinResult" class="admin-status"></pre>
      </section>
      <section class="card admin-grid">
        <div class="admin-actions">
          <button class="btn" id="loadPrizes">prizes load</button>
        </div>
        <div id="prizeStatus" class="admin-status"></div>
        <div id="prizeList" class="admin-table"></div>
      </section>
    </main>

    <script>
      const apiBaseInput = document.getElementById("apiBase");
      const adminTokenInput = document.getElementById("adminToken");
      const gachaIdInput = document.getElementById("gachaId");
      const winRateInput = document.getElementById("winRate");
      const isActiveInput = document.getElementById("isActive");
      const gachaStatus = document.getElementById("gachaStatus");
      const prizeStatus = document.getElementById("prizeStatus");
      const prizeList = document.getElementById("prizeList");
      const spinStatus = document.getElementById("spinStatus");
      const spinResult = document.getElementById("spinResult");

      const storageKeys = {
        apiBase: "admin_api_base",
        token: "admin_token",
        gachaId: "admin_gacha_id",
      };

      function loadDefaults() {
        apiBaseInput.value =
          localStorage.getItem(storageKeys.apiBase) ||
          "https://gacha-mvp.glab-74.workers.dev";
        adminTokenInput.value = localStorage.getItem(storageKeys.token) || "";
        gachaIdInput.value = localStorage.getItem(storageKeys.gachaId) || "";
      }

      function saveDefaults() {
        localStorage.setItem(storageKeys.apiBase, apiBaseInput.value.trim());
        localStorage.setItem(storageKeys.token, adminTokenInput.value.trim());
        localStorage.setItem(storageKeys.gachaId, gachaIdInput.value.trim());
      }

      function headers() {
        const token = adminTokenInput.value.trim();
        return {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
        };
      }

      function apiUrl(path) {
        return `${apiBaseInput.value.trim()}${path}`;
      }

      async function loadGacha() {
        saveDefaults();
        gachaStatus.textContent = "loading...";
        try {
          const res = await fetch(apiUrl(`/api/admin/gachas/${gachaIdInput.value.trim()}`), {
            headers: headers(),
          });
          if (!res.ok) {
            gachaStatus.textContent = `error: ${res.status}`;
            return;
          }
          const data = await res.json();
          winRateInput.value = data.win_rate ?? "";
          isActiveInput.value = String(data.is_active ?? true);
          gachaStatus.textContent = "loaded";
        } catch (error) {
          gachaStatus.textContent = "load failed";
        }
      }

      async function saveGacha() {
        saveDefaults();
        gachaStatus.textContent = "updating...";
        const payload = {};
        if (winRateInput.value !== "") payload.win_rate = Number(winRateInput.value);
        if (isActiveInput.value !== "") payload.is_active = isActiveInput.value === "true";
        try {
          const res = await fetch(apiUrl(`/api/admin/gachas/${gachaIdInput.value.trim()}`), {
            method: "PATCH",
            headers: headers(),
            body: JSON.stringify(payload),
          });
          if (!res.ok) {
            gachaStatus.textContent = `error: ${res.status}`;
            return;
          }
          gachaStatus.textContent = "updated";
        } catch (error) {
          gachaStatus.textContent = "update failed";
        }
      }

      function renderPrizes(items) {
        prizeList.innerHTML = "";
        if (!items.length) {
          prizeList.innerHTML = "<div class=\"admin-status\">no prizes</div>";
          return;
        }
        items.forEach((item) => {
          const card = document.createElement("div");
          card.className = "admin-card";
          card.innerHTML = `
            <div class="small">id: ${item.id}</div>
            <div class="admin-inline">
              <div class="admin-row">
                <label>name</label>
                <input data-field="name" value="${item.name ?? ""}" />
              </div>
              <div class="admin-row">
                <label>stock</label>
                <input data-field="stock" type="number" value="${item.stock ?? 0}" />
              </div>
              <div class="admin-row">
                <label>weight</label>
                <input data-field="weight" type="number" value="${item.weight ?? 1}" />
              </div>
              <div class="admin-row">
                <label>is_active</label>
                <select data-field="is_active">
                  <option value="true" ${item.is_active ? "selected" : ""}>true</option>
                  <option value="false" ${item.is_active ? "" : "selected"}>false</option>
                </select>
              </div>
              <div class="admin-row">
                <label>image_url</label>
                <input data-field="image_url" value="${item.image_url ?? ""}" />
              </div>
            </div>
            <div class="admin-actions">
              <button class="btn secondary" data-action="save" data-id="${item.id}">save</button>
            </div>
          `;
          card.querySelector("[data-action='save']").addEventListener("click", async () => {
            const payload = {};
            card.querySelectorAll("[data-field]").forEach((field) => {
              const key = field.dataset.field;
              let value = field.value;
              if (key === "stock" || key === "weight") value = Number(value);
              if (key === "is_active") value = value === "true";
              payload[key] = value;
            });
            try {
              const res = await fetch(apiUrl(`/api/admin/prizes/${item.id}`), {
                method: "PATCH",
                headers: headers(),
                body: JSON.stringify(payload),
              });
              if (!res.ok) {
                prizeStatus.textContent = `update error: ${res.status}`;
                return;
              }
              prizeStatus.textContent = "prize updated";
            } catch {
              prizeStatus.textContent = "prize update failed";
            }
          });
          prizeList.appendChild(card);
        });
      }

      async function loadPrizes() {
        saveDefaults();
        prizeStatus.textContent = "loading...";
        try {
          const res = await fetch(
            apiUrl(`/api/admin/gachas/${gachaIdInput.value.trim()}/prizes`),
            { headers: headers() }
          );
          if (!res.ok) {
            prizeStatus.textContent = `error: ${res.status}`;
            return;
          }
          const data = await res.json();
          renderPrizes(data.items || []);
          prizeStatus.textContent = "loaded";
        } catch (error) {
          prizeStatus.textContent = "load failed";
        }
      }

      async function saveGachaIdOnly() {
        saveDefaults();
        spinStatus.textContent = "saved";
      }

      async function testSpin() {
        saveDefaults();
        spinStatus.textContent = "testing...";
        spinResult.textContent = "";
        const gachaId = gachaIdInput.value.trim();
        if (!gachaId) {
          spinStatus.textContent = "gacha_id required";
          return;
        }
        try {
          const res = await fetch(
            apiUrl(`/api/spin?gacha_id=${encodeURIComponent(gachaId)}`),
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              credentials: "include",
            }
          );
          const text = await res.text();
          spinStatus.textContent = `status: ${res.status}`;
          spinResult.textContent = text;
        } catch {
          spinStatus.textContent = "spin failed";
        }
      }

      document.getElementById("loadGacha").addEventListener("click", loadGacha);
      document.getElementById("saveGacha").addEventListener("click", saveGacha);
      document.getElementById("loadPrizes").addEventListener("click", loadPrizes);
      document.getElementById("saveGachaId").addEventListener("click", saveGachaIdOnly);
      document.getElementById("testSpin").addEventListener("click", testSpin);

      loadDefaults();
    </script>
  </body>
</html>
