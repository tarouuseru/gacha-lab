<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Second Spin</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <header>
      <div class="brand">GACHA LAB</div>
    </header>
    <main>
      <section class="card hero">
        <h1>ログインしたら、無料でもう1回回せます</h1>
        <p class="small">さっきの結果の“続き”はここから。ログイン後にもう1回だけ回せます。</p>
        <div id="secondStatus" class="status"></div>
      </section>
      <section class="card result" id="resultCard">
        <h2 id="resultTitle">結果</h2>
        <p id="resultText">まだ回していません。</p>
        <div id="resultCta"></div>
      </section>
    </main>

    <script src="config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
      const statusEl = document.getElementById("secondStatus");
      const spinOnceKey = "secondSpinDone";
      const resultTextEl = document.getElementById("resultText");

      function showError(message) {
        if (statusEl) statusEl.textContent = message;
        if (resultTextEl) resultTextEl.textContent = message;
      }

      function guardLastSpin() {
        const cached = sessionStorage.getItem("lastSpin");
        if (!cached) return false;
        try {
          const parsed = JSON.parse(cached);
          const savedAt = Number(parsed.saved_at || 0);
          if (!savedAt) return false;
          return Date.now() - savedAt <= 5 * 60 * 1000;
        } catch {
          return false;
        }
      }

      function redirectToFirst() {
        alert("先に1回回してください");
        window.location.href = "./index.html";
      }

      async function ensureSession() {
        if (!window.APP_CONFIG) {
          showError("APP_CONFIG が読み込めていません。");
          console.error("APP_CONFIG is undefined");
          return null;
        }
        const { SUPABASE_URL, SUPABASE_ANON_KEY } = window.APP_CONFIG;
        if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
          showError("APP_CONFIG が読み込めていません。");
          console.error("Missing SUPABASE_URL or SUPABASE_ANON_KEY");
          return null;
        }
        const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const hashParams = new URLSearchParams(window.location.hash.slice(1));
        const hashError =
          hashParams.get("error_description") || hashParams.get("error");
        if (hashError) {
          showError("リンク期限切れ。もう一度ログインを試してください。");
          console.error("magic link error:", hashError);
          return null;
        }

        const params = new URLSearchParams(window.location.search);
        const code = params.get("code");
        if (code) {
          const { error } = await client.auth.exchangeCodeForSession(code);
          if (error) {
            statusEl.textContent = "ログインに失敗しました。";
            return null;
          }
          history.replaceState({}, "", window.location.pathname);
        }

        const { data } = await client.auth.getSession();
        return { client, session: data?.session || null };
      }

      async function loadSpinScript() {
        if (typeof window.spin === "function") return true;
        return new Promise((resolve) => {
          const script = document.createElement("script");
          script.src = "app.js";
          script.onload = () => resolve(true);
          script.onerror = () => resolve(false);
          document.head.appendChild(script);
        });
      }

      async function runSecondSpin() {
        if (sessionStorage.getItem(spinOnceKey)) return;
        sessionStorage.setItem(spinOnceKey, "1");
        statusEl.textContent = "回しています...";
        const loaded = await loadSpinScript();
        if (!loaded || typeof window.spin !== "function") {
          showError("spin の読み込みに失敗しました。");
          return;
        }
        console.log("second spin run: true");
        await window.spin({ mode: "second" });
        sessionStorage.removeItem("lastSpin");
        statusEl.textContent = "";
      }

      async function init() {
        console.log("second init", { url: window.location.href });
        if (!guardLastSpin()) {
          redirectToFirst();
          return;
        }

        const result = await ensureSession();
        if (!result) return;
        const { session } = result;
        console.log("has session:", !!session);

        if (!session?.access_token) {
          redirectToFirst();
          return;
        }

        await runSecondSpin();
        return;

        // ログイン済み以外は index.html に戻す仕様
      }

      document.addEventListener("DOMContentLoaded", () => {
        init().catch((error) => {
          showError("初期化に失敗しました。");
          console.error(error);
        });
      });
    </script>
  </body>
</html>
